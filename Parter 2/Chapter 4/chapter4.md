# テスト駆動開発サイクルの始め方
## はじめに

第1章で説明したTDDプロセスは、既存のインフラに新機能のテストを組み込むことでシステムを成長させることを前提としています。しかし、このインフラがまだ存在しない、最初の機能についてはどうすればよいのでしょうか。受け入れテストとして、システムの外部インターフェースに関するフィードバックを得るために、エンドツーエンドで実行する必要があります。つまり、ビルド、デプロイ、テストの自動化サイクル全体を実装しなければなりません。これは、最初のテストが失敗するのを見る前にやるべき大量の作業です。

プロジェクトの開始時点からデプロイとテストを行うことで、チームは自分たちのシステムが世界の中でどのように位置づけられるかを理解することが求められます。これにより、「知らないことすら知らない」技術的・組織的リスクが明らかになり、まだ時間があるうちに対処できます。デプロイを試みることで、システム管理者や外部ベンダーなど、誰と連携する必要があるかをチームが理解し、その関係構築を始めることもできます。

存在しないシステムに対して「ビルド、デプロイ、テスト」から始めるというのは奇妙に聞こえるかもしれませんが、私たちはこれが不可欠だと考えています。後回しにするリスクはあまりにも大きいのです。システムを確実にデプロイできないために、数ヶ月の開発の後にプロジェクトがキャンセルされた例を見てきました。新機能に数ヶ月の手動回帰テストが必要で、それでもエラー率が高すぎるためにシステムが廃棄された例も見てきました。常にそうですが、私たちはフィードバックを基本的なツールと考えており、正しい方向に進んでいるかどうかをできるだけ早く知りたいのです。そして、最初のテストを配置できれば、その後のテストははるかに速く書けるようになります。
---

## まず「ウォーキングスケルトン」をテストする

最初の受け入れテストを書いて通すときのジレンマは、ツールとそれがテストする機能の両方を同時に構築するのが難しいということです。一方の変更が他方の進捗を妨げ、アーキテクチャ、テスト、本番コードのすべてが動いているときに障害を追跡するのは困難です。

不安定な開発環境の症状の一つは、何かが失敗したときに最初に見るべき明確な場所がないことです。

この「最初の機能のパラドックス」は、二つの小さな問題に分割することで解決できます。まず、「ウォーキングスケルトン」をビルド、デプロイ、テストする方法を考え出します。次に、そのインフラを使用して最初の意味のある機能の受け入れテストを書きます。その後は、システムの残りの部分をテスト駆動開発するためのすべてが整います。

「ウォーキングスケルトン」とは、自動的にビルド、デプロイ、エンドツーエンドでテストできる、実際の機能の最も薄いスライスの実装です[Cockburn04]。最初の機能に取り組み始めるために必要な、自動化、主要コンポーネント、通信メカニズムだけを含めます。スケルトンのアプリケーション機能は、明白でつまらないほどシンプルに保ち、インフラに集中できるようにします。

たとえば、データベースを使用するWebアプリケーションの場合、スケルトンはデータベースのフィールドを表示する単純なWebページになります。第10章では、ユーザーインターフェースに単一の値を表示し、サーバーにハンドシェイクメッセージだけを送信する例を示します。

「エンドツーエンド」の「エンド」は、システムだけでなくプロセスも指すことを理解することも重要です。テストをゼロから始めて、デプロイ可能なシステムをビルドし、本番環境に近い環境にデプロイし、デプロイされたシステムを通じてテストを実行したいのです。テストプロセスにデプロイステップを含めることは、二つの理由で重要です。第一に、これは手作業で行うべきではないエラーが起きやすい作業であるため、実際にデプロイする時点までにスクリプトを十分に試しておきたいのです。繰り返し学んできた教訓の一つは、プロセスを自動化しようとすることほど、そのプロセスをよく理解させてくれるものはないということです。第二に、これは開発チームが組織の他の部分と接触し、その運営方法を学ばなければならない瞬間であることが多いのです。データベースをセットアップするのに6週間と4つの署名が必要な場合、納品の2週間前ではなく、今それを知りたいのです。

もちろん実際には、真のエンドツーエンドテストの実現が非常に難しいため、実際のシステムが何をするか、その環境がどのようなものかについての現在の理解を実装したインフラから始めなければならないこともあります。しかし、これは一時的な対処であり、本当の作業を完了できるまでの暫定的なパッチであり、テストが本当にエンドツーエンドで実行されるまで未知のリスクが残ることを心に留めておきます。オークションスナイパーの例(パートIII)の弱点の一つは、テストが実際のサイトではなくダミーサーバーに対して実行されることです。本番稼働前のある時点で、Southabee's On-Lineに対してテストする必要があったでしょう。それを早くできればできるほど、出てくる驚きに対応しやすくなります。

「ウォーキングスケルトン」を構築している間は、構造に集中し、テストをきれいに表現するためのクリーンアップについてはあまり心配しません。ウォーキングスケルトンとそれを支えるインフラは、テスト駆動開発を始める方法を見つけるためのものです。これは、完全なエンドツーエンド受け入れテストソリューションに向けた最初のステップに過ぎません。最初の機能のテストを書くときには、システムの動作を明確に表現するために、「読みたいテストを書く」必要があります。

> 早期のエンドツーエンドテストの重要性

>> 私たちは、数年間稼働していたがシステム全体をエンドツーエンドでテストしたことがないプロジェクトに参加したことがあります。本番環境での障害が頻繁に発生し、デプロイもしばしば失敗していました。システムは大規模で複雑であり、それが管理する複雑なビジネストランザクションを反映していました。自動化されたエンドツーエンドテストスイートを構築する作業があまりにも大規模だったため、その作業を実行するために全く新しいチームを編成しなければなりませんでした。エンドツーエンドのテスト環境を構築するのに数ヶ月かかり、システム全体をエンドツーエンドのテストスイートでカバーすることはできませんでした。

>> エンドツーエンドテストの必要性が設計に影響を与えていなかったため、システムはテストしにくいものでした。たとえば、システムのコンポーネントは内部タイマーを使用してアクティビティをスケジュールしており、その中には数日または数週間先のものもありました。これによりエンドツーエンドテストを書くことが非常に困難になりました。リアルタイムでテストを実行することは現実的ではありませんでしたが、スケジューリングはシステムの外部から影響を与えることができませんでした。開発者は、定期的なアクティビティがリモートスケジューラから送信されるメッセージによってトリガーされ、テスト環境で置き換えられるようにシステム自体を再設計しなければなりませんでした。「イベントソースの外部化」(326ページ)を参照してください。これは重要なアーキテクチャの変更でした—そして、エンドツーエンドのテストカバレッジなしで実行しなければならなかったため、非常にリスクが高いものでした。

---
## ウォーキングスケルトンの形を決める

「ウォーキングスケルトン」の開発は、アプリケーションの高レベルな構造について意思決定を始めるタイミングです。ビルド、デプロイ、テストサイクルを自動化するには、全体的な構造についてある程度の考えが必要です。まだ詳細は必要ありません。最初の計画されたリリースをサポートするために必要な主要なシステムコンポーネントと、それらがどのように通信するかについての大まかな全体像だけです。私たちの経験則は、「ウォーキングスケルトン」の設計をホワイトボード上で数分で描けるべきだということです。

この初期構造を設計するには、システムの目的についてある程度理解している必要があります。そうでなければ、全体の演習が無意味になるリスクがあります。選択を導くために、機能要件と非機能要件の両方について、クライアントの要件の高レベルビューが必要です。この準備作業はプロジェクトのチャーター作成の一部であり、本書の範囲外として残す必要があります。

「ウォーキングスケルトン」のポイントは、最初のテストを書くことでプロジェクトのコンテキストを引き出し、チームがソリューションの全体像—コードを書く前に取らなければならない本質的な決定—をマッピングするのを助けることです。

これをアジャイル開発コミュニティで悪評のある「事前の大規模設計」(BDUF)と混同しないでください。コーディングを始める前に、クラスやアルゴリズムまで設計全体を詳細化しようとしているわけではありません。今持っているアイデアは間違っている可能性が高いので、システムを成長させながらそれらの詳細を発見することを好みます。TDDサイクルを始動させ、実際のフィードバックから学習し改善を始めるために、可能な限り最小限の決定を行っているのです。

---

## フィードバックの源を構築する

アプリケーションの設計について下した決定や、それらが基づいている仮定が正しいという保証はありません。できる限りのことをしますが、信頼できる唯一のことは、プロセスにフィードバックを組み込むことで、できるだけ早くそれらを検証することです。「ウォーキングスケルトン」を実装するために構築するツールは、この学習プロセスをサポートするためのものです。もちろん、これらのツールも完璧ではありませんし、チームをどれだけうまくサポートするかを学ぶにつれて、段階的に改善していくことを期待しています。

私たちの理想的な状況は、図4.3のように、チームが実際の本番システムに定期的にリリースすることです。これにより、システムの利害関係者はシステムがニーズをどれだけ満たしているかに応答でき、同時に私たちはその実装を判断できます。

ビルドとテストの自動化を使用して、バージョンのカットとデプロイがどれだけ容易か、設計がどれだけうまく機能しているか、コードがどれだけ良いかなど、システムの品質についてフィードバックを得ます。自動化されたデプロイは、実際のユーザーに頻繁にリリースするのに役立ち、ドメインをどれだけ理解しているか、システムを実際に見ることで顧客の優先順位が変わったかどうかについてフィードバックを得られます。

大きな利点は、学んだことに応じて変更を加えられることです。なぜなら、すべてをテストファーストで書くことで、徹底的な回帰テストセットを持つことになるからです。もちろん、完璧なテストはありませんが、実際には、実質的なテストスイートがあれば安全に大きな変更を加えられることがわかっています。

---

# 不確実性を早期に明らかにする

これらすべての努力は、ほとんど何もしないにもかかわらず、「ウォーキングスケルトン」を動作させるのにかかる時間に、チームがしばしば驚くことを意味します。これは、この最初のステップが多くのインフラを確立し、多くの厄介な質問をする(そして答える)ことを含むためです。最初のいくつかの機能を実装する時間は、チームが要件とターゲット環境についてさらに発見するにつれて予測不可能になります。新しいチームの場合、これは一緒に働く方法を学ぶという社会的ストレスによってさらに複雑になります。

同僚のフレッド・ティンギーは、段階的開発に慣れていないチームやマネジメントにとって、それが不安にさせるものになり得ることに気づきました。なぜなら、プロジェクトの初期にストレスを集中させるからです。後期統合を行うプロジェクトは穏やかに始まりますが、チームが初めてシステムをまとめようとする終盤に向けて一般的に困難になります。後期統合は予測不可能です。なぜなら、チームは限られた時間と予算で多くの動く部品を組み立て、障害を修正しなければならないからです。その結果、経験豊富な利害関係者は、段階的プロジェクトの開始時の不安定さに悪い反応を示します。なぜなら、プロジェクトの終わりがはるかに悪化することを期待しているからです。

私たちの経験では、うまく運営される段階的開発は逆の方向に進みます。不安定に始まりますが、いくつかの機能が実装され、プロジェクトの自動化が構築された後、日常的なものに落ち着きます。プロジェクトが納品に近づくにつれて、エンドゲームは機能の着実な生産であるべきで、おそらく最初のリリース前に活動のバーストがあります。デプロイやアップグレードなどの退屈だが壊れやすいタスクはすべて自動化されており、「ただ動作する」ようになります。対比は図4.4のように見えます。

![4.4](./figure_4.4.png.png)

テスト駆動開発のこの側面は、他のものと同様に、直感に反するように見えるかもしれませんが、システムの基礎を構造化し自動化するために十分な時間をかけることは、常に価値があると感じてきました—または少なくとも最初のカットを。もちろん、完璧な「ウォーキングスケルトン」をセットアップするためにプロジェクト全体を費やしたくはないので、ホワイトボードレベルの決定に限定し、必要なときに考えを変える権利を留保します。しかし、最も重要なことは、方向性の感覚と仮定をテストするための具体的な実装を持つことです。

テストファーストとテスト後のプロジェクトにおける可視的な不確実性「ウォーキングスケルトン」は、まだ時間、予算、善意がある早い段階でプロジェクトの問題を明らかにします。

この側面を含め、テスト駆動開発は直観に反して見えるかもしれません。しかし、私たちは常に、システムの基本（少なくとも最初の叩き台）を十分な時間をかけて構造化し、自動化する価値があると考えています。もちろん、プロジェクト全体を「完璧なウォーキングスケルトン」の整備に費やすべきではありません。決定はホワイトボードレベルにとどめ、必要に応じて考えを改める権利を確保します。最も重要なのは、進むべき方向感と、前提を検証できる具体的な実装を持つことです。

「ウォーキングスケルトン」は、プロジェクトの早い段階で問題を炙り出します。その時点なら、対処するための時間も予算も、そして善意（協力的な空気）も、まだ残っているのです。

---

# ブラウンフィールド開発

常にゼロから新しいシステムを構築できる贅沢があるわけではありません。私たちのプロジェクトの多くは、拡張、適応、または置き換える必要がある既存のシステムから始まっています。そのような場合、「ウォーキングスケルトン」を構築することから始めることはできません。その構造がどれほど敵対的であっても、既存のものを使用しなければなりません。

とはいえ、既存のシステムのTDDを始動させるプロセスは、新しいシステムに適用することと根本的に異なるわけではありません—システムがすでに抱えている技術的な重荷のために、桁違いに困難かもしれませんが。マイケル・フェザーズはこのトピックについて本全体を書いています[Feathers04]。

回帰を検出するテストがない状態でシステムの再作業を始めるのはリスクがあります。TDDプロセスを開始する最も安全な方法は、ビルドとデプロイのプロセスを自動化し、変更する必要があるコードの領域をカバーするエンドツーエンドテストを追加することです。その保護があれば、より自信を持って内部品質の問題に取り組み始めることができ、機能を追加しながらコードをリファクタリングし、単体テストを導入できます。

エンドツーエンドテストインフラの構築を始める最も簡単な方法は、見つけられる最もシンプルなシステムのパスを使用することです。「ウォーキングスケルトン」のように、これにより、より複雑な機能のテストという難しい問題に取り組む前に、サポートインフラを構築できます。

---
